version: '3'

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task -l

  build:
    desc: Build all packages
    cmds:
      - go build -v ./...
    silent: true

  test:
    desc: Run all tests
    cmds:
      - mkdir -p test-results
      - go test -v -race -coverprofile=test-results/coverage.txt -covermode=atomic ./... > test-results/test-output.log 2>&1 || (cat test-results/test-output.log && exit 1)
      - echo "Test results saved to test-results/test-output.log"
      - echo "Coverage report saved to test-results/coverage.txt"
    silent: true

  test-verbose:
    desc: Run tests with verbose output to console
    cmds:
      - go test -v -race -coverprofile=test-results/coverage.txt -covermode=atomic ./...

  test-short:
    desc: Run short tests
    cmds:
      - mkdir -p test-results
      - go test -short -v ./... > test-results/test-short.log 2>&1 || (cat test-results/test-short.log && exit 1)
      - echo "Short test results saved to test-results/test-short.log"
    silent: true

  lint:
    desc: Run linter
    cmds:
      - which golangci-lint || (echo "Installing golangci-lint v1..." && go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.8)
      - mkdir -p test-results
      - golangci-lint run --no-config --enable=gosec,misspell,errcheck,gosimple --timeout=10m > test-results/lint.log 2>&1 || true
      - echo "Lint results saved to test-results/lint.log"

  fmt:
    desc: Format code
    cmds:
      - gofmt -s -w .
      - goimports -w .

  tidy:
    desc: Clean up modules
    cmds:
      - go mod tidy
      - go mod verify

  ci-verify:
    desc: Run CI verification locally
    cmds:
      - task tidy
      - task build
      - task test
      - task lint
    silent: true

  install-tools:
    desc: Install development tools
    cmds:
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.8
      - go install golang.org/x/tools/cmd/goimports@latest
      - go install github.com/securego/gosec/v2/cmd/gosec@latest

  setup-hooks:
    desc: Set up git hooks
    cmds:
      - echo "Setting up pre-commit hook..."
      - cp scripts/pre-commit.sh .git/hooks/pre-commit
      - chmod +x .git/hooks/pre-commit
      - echo "✓ Pre-commit hook installed"

  coverage:
    desc: Show coverage report
    cmds:
      - mkdir -p test-results
      - "go tool cover -html=test-results/coverage.txt -o test-results/coverage.html"
      - "echo 'Coverage report generated: test-results/coverage.html'"
    deps: [test]

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf test-results
      - rm -f golangci-lint-report.xml
      - go clean -cache

  deps-update:
    desc: Update dependencies
    cmds:
      - go get -u ./...
      - go mod tidy

  security-scan:
    desc: Run security scan
    cmds:
      - which gosec || go install github.com/securego/gosec/v2/cmd/gosec@latest
      - gosec -fmt json -out gosec-report.json ./...
      - "echo 'Security report generated: gosec-report.json'"

  docker-test:
    desc: Run tests in Docker (simulates CI)
    cmds:
      - docker run --rm -v "{{.PWD}}:/app" -w /app golang:1.25 bash -c "go mod download && go test -v -race ./... > test-results/docker-test.log 2>&1 || (cat test-results/docker-test.log && exit 1)"
    ignore_error: true

  pipeline-debug:
    desc: Debug pipeline issues locally
    cmds:
      - echo "=== Checking Go version ==="
      - go version
      - echo "=== Checking modules ==="
      - go mod verify
      - echo "=== Building ==="
      - go build -v ./...
      - echo "=== Testing ==="
      - echo "Test results will be saved to test-results/pipeline-test.log"
      - go test -v ./... -count=1 > test-results/pipeline-test.log 2>&1 || (cat test-results/pipeline-test.log && exit 1)
      - echo "✓ Tests completed - see test-results/pipeline-test.log for details" > test-results/pipeline-test.log 2>&1 || (cat test-results/pipeline-test.log && exit 1)
      - echo "=== Checking for changes ==="
      - git status --porcelain go.mod go.sum || echo "No changes to go.mod/go.sum"